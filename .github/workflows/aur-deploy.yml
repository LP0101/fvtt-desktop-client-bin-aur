name: Update AUR Package

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:  

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
    steps:
      - name: Install System Dependencies
        run: |
          pacman -Syu --noconfirm git pacman-contrib jq curl openssh

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for New Version
        id: check_version
        run: |
          # 1. Get latest tag from GitHub API
          # We use JeidoUran as discussed
          LATEST_TAG=$(curl -s https://api.github.com/repos/JeidoUran/fvtt-player-client/releases/latest | jq -r .tag_name | sed 's/v//')
          
          # 2. Extract current version from PKGBUILD
          CURRENT_VER=$(grep -P -o '(?<=^pkgver=).*' PKGBUILD)
          
          echo "Latest found: $LATEST_TAG"
          echo "Current in repo: $CURRENT_VER"
          
          if [ "$LATEST_TAG" == "$CURRENT_VER" ]; then
            echo "No update needed."
            echo "update_available=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected!"
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "new_ver=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Update PKGBUILD and .SRCINFO
        if: steps.check_version.outputs.update_available == 'true'
        run: |
          # Update the version string
          sed -i "s/^pkgver=.*/pkgver=${{ steps.check_version.outputs.new_ver }}/" PKGBUILD
          
          # updpkgsums needs to run as a non-root user
          useradd -m builder
          chown -R builder:builder .
          sudo -u builder updpkgsums
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Push to AUR
        if: steps.check_version.outputs.update_available == 'true'
        uses: KSXGitHub/github-actions-deploy-aur@v3
        with:
          pkgname: fvtt-desktop-client-bin
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to v${{ steps.check_version.outputs.new_ver }}"
          ssh_keyscan_types: rsa,ed25519

      - name: Commit changes back to GitHub
        if: steps.check_version.outputs.update_available == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Automated version bump to ${{ steps.check_version.outputs.new_ver }}"
          git push